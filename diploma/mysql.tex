\section{Парсер MySQL}
Для дальнейшей работы был выбран парсер MySQL за авторством \textbf{stevenmiller888}, написанный на \textit{TypeScript} и использующий \textit{ANTLR4}. Выбор обусловлен тем, что данный парсер имеет лицензию \textit{MIT License}, совместимой с \textit{Apache License 2.0}, используемой в ClickHouse.

Тот факт, что парсер написан с использованием \textit{ANTLR4}, позволяет успешно внедрить его в кодовую базу ClickHouse, несмотря на то, что ClickHouse и выбраный парсер написаны на разных языках.

\subsection{Структура парсера MySQL}
Исходный репозиторий представляет собой полноценную библиотеку, предоставляющую разбор MySQL запроса. Однако в рамках данной работы интерес представляют лишь некоторые из них:
\begin{itemize}
    \item src/\_\_tests\_\_
    \begin{itemize}
        \item ...
        \item \textbf{statements.txt} - запросы для тестирования
        \item ...
    \end{itemize}
    \item src/grammar
    \begin{itemize}
        \item ...
        \item \textbf{MySQLLexer.g4}, \textbf{MySQLParser.g4} - файлы грамматики
        \item \textbf{MySQLBaseLexer.ts}, \textbf{MySQLBaseParser.ts} - базовые классы
        \item \textbf{common.ts} - общие константы
        \item \textbf{predefined.tokens} - список предопределенных токенов
        \item ...
    \end{itemize}
\end{itemize}

\pagebreak

Файл \textbf{MySQLLexer.g4} содержит описывает токены и правила их вывода из подстрок запроса. Файл \textbf{MySQLParser.g4} содержит описание грамматике через расширенную форму Бэкуса — Наура. \textit{ANTLR4} позволяет генерировать из файлов грамматики код анализаторов на различных языках, оригинальный проект использовал \textit{TypeScript}, однако возможна и генерация C++ кода, что и было сделано.

Файлы \textbf{MySQLBaseLexer.ts} и \textbf{MySQLBaseParser.ts} описывают базовые классы, от которых наследуются классы лексера и парсера. В ходе подготовки к интеграции MySQL парсера в ClickHouse, эти классы были переписаны на C++ вручную. 

Файл \textbf{statements.txt} содержит MySQL запросы, разделенные символом \enquote{;} и используются в оригинальном проекте для проверки корректности работы парсера. На основании этого файла в дальнейшем будут реализованы юнит-тесты парсера MySQL в ClickHouse (см ССЫЛКА НА ЮНИТЫ)

Итого, переписаный на C++ парсер MySQL, готовый к включению в кодовую базу ClickHouse, имеет следующую структуру:
\begin{itemize}
    \item \textbf{statements.txt} - запросы для тестирования
    \item \textbf{MySQLLexer.g4}, \textbf{MySQLParser.g4} - файлы грамматики
    \item \textbf{MySQLBaseLexer.h}, \textbf{MySQLBaseParser.h} - базовые классы (заголовки, переписано на C++)
    \item \textbf{MySQLBaseLexer.cpp}, \textbf{MySQLBaseParser.cpp} - базовые классы (имплементация, переписано на C++)
    \item \textbf{SqlMode.h} - общие константы (бывший \textbf{common.ts}, переписано на C++)
    \item \textbf{predefined.tokens} - список предопределенных токенов
\end{itemize}

\pagebreak

\textit{ANTLR4} генерирует из файлов, обозначенных выше, исходный код анализаторов, которые будут непосредственно осуществлять разбор MySQL запроса. В дальнейшем из них будут использваны:

\begin{itemize}
    \item ...
    \item \textbf{MySQLLexer.h}, \textbf{MySQLLexer.cpp} - лексический анализатор
    \item \textbf{MySQLParser.h}, \textbf{MySQLParser.cpp} - синтаксический анализатор (парсер)
    \item ...
\end{itemize}

\subsection{Интеграция парсера MySQL в ClickHouse}
После извлечения и модификации (по большей части - переписывание на C++) обозначеных выше элементов парсера, была проведена работа по интеграции парсера MySQL в ClickHouse. Анализаторы, основанные на \textit{ANTLR4} на языке C++, требуют т. н. \textit{рантайм} (библиотеку, описывающую базовые интерфейсы и алгоритмы) для своей работы. 

\textit{Рантайм} необходимой версии (\textit{antlr4.8}) был включен в кодовую базу ClickHouse в качестве \textit{сабмодуля} в директорию \textit{contrib/} и добавлены в систему сборки (\textit{ninja} + \textit{CMake}). Код парсера помещен в директорию\\ \textit{src/Parsers/MySQLCompatibility/ANTLR}.

Система сборки ClickHouse ориентирована на то, чтобы обнаруживать как можно больше ошибок на этапе компиляции. С этой целью исходный код собирается с включенными флагами компиляции, отвечающими за проверку предупреждений (\mintinline{bash}{ -Wall -Wextra -Wpedantic }, и т д). В ходе интеграции обнаружилось, что код, сгенерированый \textit{ANTLR4}, не удовлетворяет требованиям ClickHouse. Для исправления этой проблемы, было принято решение выделить файлы исходного кода MySQL парсера в отдельную библиотеку со своими фалгами компиляции, лежащую по пути \textit{src/Parsers/MySQLCompatibility/ANTRL}. 

Весь исходный код, работающий с результатами паресра, но не взаимодействующий с ClickHouse напрямую (создание MySQL AST, оберточные классы), размещен в директории \textit{src/Parsers/MySQLCompatibility/ParserOverlay}. Итого, конфигурация сборки имеет следующий вид (см. Листинг \ref{mysql:cmake}

В итоге, кофигурицаия сборки приняла следующий вид:
\begin{code}
    \captionof{listing}{Структура сборки парсера. CMake}
    \label{mysql:cmake}
    \begin{minted}[fontsize=\footnotesize, frame=single]{cmake}
    # ...

    add_headers_and_sources(clickhouse_parsers ./MySQLCompatibility)
    add_headers_and_sources(mysql_parser ./MySQLCompatibility/ANTLR)
    add_headers_and_sources(mysql_parser ./MySQLCompatibility/ParserOverlay)

    add_library(clickhouse_parsers ${clickhouse_parsers_headers}
            ${clickhouse_parsers_sources})
    add_library(mysql_parser ${mysql_parser_headers} ${mysql_parser_sources})

    target_link_libraries(mysql_parser PUBLIC antlr4-runtime)
    target_link_libraries(clickhouse_parsers PUBLIC clickhouse_common_io
            clickhouse_common_access mysql_parser)

    # ...
    \end{minted}
\end{code}

\subsection{MySQL AST}
Дерево разбора, получаемое в результате парсинга, имеет довольно сложную структуру, включающую избыточную для поставленной задачи информацию. С целью упростить дерево разбора для дальнейшего его использования в рамках метода конвертации, был написан алгоритм, преобразующий его в \textit{абстрактное синтаксическое дерево} (ниже и в дальнейшем - \textbf{MySQL AST}. Каждая вершина MySQL AST будет иметь тип \mintinline{c++}{ AST } и будет содержать в себе следующую информацию: список детей (поле \mintinline{c++}{ children }), название правила (поле \mintinline{c++}{ rule_name }), которому соответсвует вершина, значения (поле \mintinline{c++}{ terminals }) и типы (поле \mintinline{c++}{  terminal_types }) терминалов, относиящихся непосредственно к вершине. 

\begin{code}
    \captionof{listing}{Структура MySQL AST}
    \label{mysql:AST_cpp}
    \begin{minted}[frame=single, fontsize=\footnotesize]{c++}
class AST
{
public:
    // construct AST from query string (via ANTLR parser)
    static bool FromQuery(const std::string & query,
            ASTPtr & result, std::string & error);
public:
    std::string rule_name;
    std::vector<ASTPtr> children;
    std::vector<std::string> terminals;
    std::vector<TOKEN_TYPE> terminal_types;
};
    \end{minted}
\end{code}

MySQL AST создается рекурсивным алгоритмом (наподобие поиска в глубину), путем извлечения необходимых данных из \textit{ANTLR4} дерева разбора и сопоставления каждой его вершине новой вершины MySQL AST.

\pagebreak
